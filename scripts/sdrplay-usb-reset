#!/bin/bash
#
# sdrplay-usb-reset - Power cycle SDRplay USB devices and companion hubs
#
# This script is designed to be added to sudoers for passwordless execution:
#
#   # Add to /etc/sudoers.d/sdrplay (use visudo -f /etc/sudoers.d/sdrplay)
#   %sdrplay ALL=(ALL) NOPASSWD: /usr/local/bin/sdrplay-usb-reset
#
# Then add users to the 'sdrplay' group:
#   sudo dseditgroup -o create sdrplay           # macOS
#   sudo groupadd sdrplay                        # Linux
#   sudo usermod -a -G sdrplay $USER             # Add user to group
#
# Requirements:
#   - uhubctl: https://github.com/mvp/uhubctl
#   - A USB hub that supports per-port power switching
#
# Installation:
#   sudo cp sdrplay-usb-reset /usr/local/bin/
#   sudo chmod 755 /usr/local/bin/sdrplay-usb-reset
#
# Usage:
#   sdrplay-usb-reset [OPTIONS]
#
# Options:
#   --aggressive    Also power cycle USB3 companion hubs and empty ports
#   --all           Power cycle ALL controllable ports (nuclear option)
#   --hub HUB       Power cycle specific hub (e.g., 2-1.1.4)
#
# If no options provided, only SDRplay devices will be reset.
#

set -e

AGGRESSIVE=false
RESET_ALL=false
SPECIFIC_HUB=""
SDRPLAY_VID="1df7"

# Parse arguments
while [[ $# -gt 0 ]]; do
    case "$1" in
        --aggressive|-a)
            AGGRESSIVE=true
            shift
            ;;
        --all)
            RESET_ALL=true
            shift
            ;;
        --hub|-h)
            SPECIFIC_HUB="$2"
            shift 2
            ;;
        *)
            # Legacy: treat as serial number (ignored for now)
            shift
            ;;
    esac
done

# Check for uhubctl
if ! command -v uhubctl &>/dev/null; then
    echo "Error: uhubctl not found. Install from https://github.com/mvp/uhubctl" >&2
    exit 1
fi

# Find hub path for a device based on uhubctl output
# USB3 devices often have a companion USB2 hub (e.g., 2-1.1.4 has companion 1-1.1.4)
get_companion_hub() {
    local hub="$1"
    # USB3 hubs typically start with 2-, companion USB2 starts with 1-
    # And vice versa
    if [[ "$hub" == 2-* ]]; then
        echo "${hub/2-/1-}"
    elif [[ "$hub" == 1-* ]]; then
        echo "${hub/1-/2-}"
    else
        echo ""
    fi
}

# Power cycle a specific hub (all ports)
power_cycle_hub() {
    local hub="$1"
    local wait_time="${2:-3}"

    echo "Power cycling hub $hub..."

    # Turn off all ports
    if uhubctl -l "$hub" -a off 2>/dev/null; then
        sleep "$wait_time"
        # Turn on all ports
        uhubctl -l "$hub" -a on 2>/dev/null
        echo "  Hub $hub power cycled"
        return 0
    else
        echo "  Hub $hub not found or not controllable"
        return 1
    fi
}

# Find all hubs containing SDRplay devices
find_sdrplay_hubs() {
    local uhubctl_status="$1"
    local current_hub=""
    local sdrplay_hubs=""

    while IFS= read -r line; do
        # Match hub header lines like "Current status for hub 2-1.1.4"
        if [[ "$line" =~ "Current status for hub "([0-9.-]+) ]]; then
            current_hub="${BASH_REMATCH[1]}"
        fi
        # Check if this line contains an SDRplay device
        if [[ "$line" =~ $SDRPLAY_VID ]] && [ -n "$current_hub" ]; then
            if [[ ! "$sdrplay_hubs" =~ "$current_hub" ]]; then
                sdrplay_hubs="$sdrplay_hubs $current_hub"
            fi
        fi
    done <<< "$uhubctl_status"

    echo "$sdrplay_hubs"
}

# Find all hubs with empty/inactive ports (Rx.Detect, power but no device)
find_empty_hubs() {
    local uhubctl_status="$1"
    local current_hub=""
    local empty_hubs=""

    while IFS= read -r line; do
        # Match hub header lines
        if [[ "$line" =~ "Current status for hub "([0-9.-]+) ]]; then
            current_hub="${BASH_REMATCH[1]}"
        fi
        # Look for ports with power but no device (Rx.Detect or similar)
        # These show up as ports with power but without a vendor:product ID
        if [[ "$line" =~ "power" ]] && [[ ! "$line" =~ [0-9a-f]{4}:[0-9a-f]{4} ]] && [ -n "$current_hub" ]; then
            if [[ ! "$empty_hubs" =~ "$current_hub" ]]; then
                empty_hubs="$empty_hubs $current_hub"
            fi
        fi
    done <<< "$uhubctl_status"

    echo "$empty_hubs"
}

# Main logic
main() {
    echo "SDRplay USB Reset Tool"
    echo "======================"
    echo ""

    # First, list what uhubctl can see
    local uhubctl_status
    uhubctl_status=$(uhubctl -a status 2>&1 || true)

    if echo "$uhubctl_status" | grep -qi "no compatible"; then
        echo "Error: No compatible USB hubs found." >&2
        echo "See https://github.com/mvp/uhubctl for compatible hub list." >&2
        exit 1
    fi

    # Handle specific hub request
    if [ -n "$SPECIFIC_HUB" ]; then
        echo "Power cycling specific hub: $SPECIFIC_HUB"
        power_cycle_hub "$SPECIFIC_HUB" 3
        echo ""
        echo "Done. You may need to restart the SDRplay service:"
        echo "  sudo sdrplay-service-restart"
        exit 0
    fi

    # Handle reset all
    if [ "$RESET_ALL" = true ]; then
        echo "WARNING: Power cycling ALL controllable USB ports!"
        echo "This will temporarily disconnect all USB devices on controllable hubs."
        echo ""
        read -r -p "Continue? [y/N] " response
        if [[ ! "$response" =~ ^[Yy]$ ]]; then
            echo "Aborted."
            exit 1
        fi
        echo ""
        echo "Turning off all USB ports..."
        uhubctl -a off 2>/dev/null || true
        sleep 3
        echo "Turning on all USB ports..."
        uhubctl -a on 2>/dev/null || true
        sleep 3
        echo ""
        echo "All ports power cycled."
        echo "You may need to restart the SDRplay service:"
        echo "  sudo sdrplay-service-restart"
        exit 0
    fi

    echo "Looking for SDRplay devices (VID: $SDRPLAY_VID)..."
    echo ""

    # Find SDRplay devices
    local sdrplay_hubs
    sdrplay_hubs=$(find_sdrplay_hubs "$uhubctl_status")

    if [ -z "$sdrplay_hubs" ]; then
        echo "No SDRplay devices found in uhubctl-compatible hubs."
        echo ""
        if [ "$AGGRESSIVE" = true ]; then
            echo "Aggressive mode: Looking for empty/inactive USB ports..."
            local empty_hubs
            empty_hubs=$(find_empty_hubs "$uhubctl_status")
            if [ -n "$empty_hubs" ]; then
                echo "Found hubs with inactive ports:$empty_hubs"
                for hub in $empty_hubs; do
                    power_cycle_hub "$hub" 2
                done
            fi
        else
            echo "Current uhubctl status:"
            echo "$uhubctl_status"
            echo ""
            echo "Tip: Use --aggressive to also power cycle empty/inactive ports"
            echo "     Use --all to power cycle everything (nuclear option)"
        fi
        exit 1
    fi

    echo "Found SDRplay device(s) on hubs:$sdrplay_hubs"
    echo ""

    # Power cycle hubs with SDRplay devices
    for hub in $sdrplay_hubs; do
        power_cycle_hub "$hub" 2

        # In aggressive mode, also cycle companion hub
        if [ "$AGGRESSIVE" = true ]; then
            local companion
            companion=$(get_companion_hub "$hub")
            if [ -n "$companion" ]; then
                echo "  Also cycling companion hub: $companion"
                power_cycle_hub "$companion" 2 || true
            fi
        fi
    done

    # In aggressive mode, also cycle hubs with empty ports
    if [ "$AGGRESSIVE" = true ]; then
        echo ""
        echo "Aggressive mode: Checking for empty/inactive USB ports..."
        local empty_hubs
        empty_hubs=$(find_empty_hubs "$uhubctl_status")

        for hub in $empty_hubs; do
            # Skip if we already cycled this hub
            if [[ ! "$sdrplay_hubs" =~ "$hub" ]]; then
                echo "  Cycling hub with empty ports: $hub"
                power_cycle_hub "$hub" 2 || true
            fi
        done
    fi

    # Wait for devices to re-enumerate
    echo ""
    echo "Waiting for devices to re-enumerate..."
    sleep 3

    echo ""
    echo "USB reset complete."
    echo ""
    echo "Next steps:"
    echo "  1. Restart the SDRplay service: sudo sdrplay-service-restart"
    echo "  2. Test device: SoapySDRUtil --probe=\"driver=sdrplay\""
}

main "$@"
