#!/bin/bash
#
# sdrplay-service-restart - Restart the SDRplay API service
#
# This script is designed to be added to sudoers for passwordless execution:
#
#   # Add to /etc/sudoers.d/sdrplay (use visudo -f /etc/sudoers.d/sdrplay)
#   %sdrplay ALL=(ALL) NOPASSWD: /usr/local/bin/sdrplay-service-restart
#
# Then add users to the 'sdrplay' group:
#   sudo dseditgroup -o create sdrplay           # macOS
#   sudo groupadd sdrplay                        # Linux
#   sudo usermod -a -G sdrplay $USER             # Add user to group
#
# Installation:
#   sudo cp sdrplay-service-restart /usr/local/bin/
#   sudo chmod 755 /usr/local/bin/sdrplay-service-restart
#

set -e

# Parse arguments
FORCE_RESTART=false
for arg in "$@"; do
    case "$arg" in
        --force|-f) FORCE_RESTART=true ;;
    esac
done

# Detect platform and restart service
case "$(uname -s)" in
    Darwin)
        # macOS - use launchctl
        # Try multiple possible plist locations
        PLIST=""
        for p in \
            "/Library/LaunchDaemons/com.sdrplay.apiservice.plist" \
            "/Library/LaunchDaemons/com.sdrplay.service.plist" \
            "/Library/SDRplayAPI/3.15.1/plist/com.sdrplay.service.plist" \
            "/Library/SDRplayAPI/3.14/plist/com.sdrplay.service.plist"; do
            if [ -f "$p" ]; then
                PLIST="$p"
                break
            fi
        done

        if [ -z "$PLIST" ]; then
            # Try to find it
            PLIST=$(find /Library -name "com.sdrplay*.plist" 2>/dev/null | head -1)
        fi

        if [ -z "$PLIST" ] || [ ! -f "$PLIST" ]; then
            echo "Error: SDRplay service plist not found" >&2
            echo "Tried: /Library/LaunchDaemons/com.sdrplay.*.plist" >&2
            echo "       /Library/SDRplayAPI/*/plist/com.sdrplay.*.plist" >&2
            exit 1
        fi

        echo "Using plist: $PLIST"
        echo "Restarting SDRplay API service..."

        # Try SIGHUP first (unless --force), then verify responsiveness
        if [ "$FORCE_RESTART" = false ] && pgrep -f sdrplay_apiService >/dev/null 2>&1; then
            echo "Sending SIGHUP to service..."
            pkill -HUP -f sdrplay_apiService 2>/dev/null || true
            sleep 3

            if pgrep -f sdrplay_apiService >/dev/null 2>&1; then
                echo "SDRplay API service restarted via SIGHUP"
                exit 0
            fi
        fi

        # Full restart (either --force or SIGHUP failed)
        echo "Full restart..."

        # First try graceful unload
        launchctl bootout system/com.sdrplay.service 2>/dev/null || \
            launchctl unload "$PLIST" 2>/dev/null || true

        # Give it a moment to stop gracefully
        sleep 1

        # Force kill any remaining service processes
        killall -9 sdrplay_apiService 2>/dev/null || true

        # Wait for process to fully exit
        for i in 1 2 3 4 5; do
            if ! pgrep -f sdrplay_apiService >/dev/null 2>&1; then
                break
            fi
            sleep 1
        done

        # If still running, it's stuck - try harder
        if pgrep -f sdrplay_apiService >/dev/null 2>&1; then
            echo "Service stuck, forcing termination..."
            pkill -9 -f sdrplay_apiService 2>/dev/null || true
            sleep 2
        fi

        # Clear any stale lock files that might cause mutex issues
        echo "Clearing stale lock files..."
        rm -f /var/folders/*/*/T/*sdrplay*.lock 2>/dev/null || true
        rm -f /tmp/*sdrplay* 2>/dev/null || true

        # Wait for USB devices to settle
        sleep 2

        echo "Starting SDRplay API service..."
        launchctl bootstrap system "$PLIST" 2>/dev/null || \
            launchctl load "$PLIST"

        # Wait for service to initialize
        sleep 3

        # Verify service is running
        if pgrep -f sdrplay_apiService >/dev/null 2>&1; then
            echo "SDRplay API service restarted successfully"
        else
            echo "Warning: Service may not have started correctly"
            exit 1
        fi
        ;;

    Linux)
        # Linux - try systemctl first, then init.d
        if command -v systemctl &>/dev/null; then
            # systemd
            SERVICE_NAME=""
            for name in sdrplayService sdrplay.api sdrplay-api sdrplay; do
                if systemctl list-unit-files | grep -q "^$name"; then
                    SERVICE_NAME="$name"
                    break
                fi
            done

            if [ -z "$SERVICE_NAME" ]; then
                echo "Error: Could not find SDRplay service in systemd" >&2
                exit 1
            fi

            echo "Restarting SDRplay service ($SERVICE_NAME)..."
            systemctl restart "$SERVICE_NAME"
            echo "SDRplay service restarted successfully"
        elif [ -x /etc/init.d/sdrplayService ]; then
            # SysV init
            echo "Restarting SDRplay service..."
            /etc/init.d/sdrplayService restart
            echo "SDRplay service restarted successfully"
        else
            echo "Error: Could not find SDRplay service" >&2
            exit 1
        fi
        ;;

    *)
        echo "Error: Unsupported platform $(uname -s)" >&2
        exit 1
        ;;
esac

exit 0
